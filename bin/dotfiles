#!/usr/bin/env bash

# =============================================================================
# DOTFILES MANAGEMENT COMMAND
# =============================================================================

set -euo pipefail

DOTFILES_DIR="$HOME/.dotfiles"

# Source utilities with absolute paths
SCRIPTS_DIR="$DOTFILES_DIR/scripts"
source "$SCRIPTS_DIR/utils.sh"

# Temporarily change to scripts directory for config.sh relative sourcing
pushd "$SCRIPTS_DIR" > /dev/null
source "./config.sh"
popd > /dev/null

# =============================================================================
# DEPENDENCY DEFINITIONS (single source of truth)
# =============================================================================

# Homebrew packages required by dotfiles
BREW_PACKAGES=(
    # Modern CLI replacements
    eza           # ls replacement
    bat           # cat replacement
    fd            # find replacement
    ripgrep       # grep replacement
    fzf           # fuzzy finder
    ncdu          # du replacement
    htop          # top replacement
    duf           # df replacement
    prettyping    # ping replacement
    trash         # safe rm

    # Shell & prompt
    starship      # prompt
    zoxide        # cd replacement
    atuin         # shell history
    direnv        # env per directory

    # Development
    mise          # tool version manager
    gh            # GitHub CLI

    # Security
    gnupg         # GPG
    pinentry-mac  # GPG pinentry for macOS
)

# Oh My Zsh custom plugins: "name|repo_url"
OMZ_CUSTOM_PLUGINS=(
    "fzf-tab|https://github.com/Aloxaf/fzf-tab"
    "forgit|https://github.com/wfxr/forgit"
    "zsh-autopair|https://github.com/hlissner/zsh-autopair"
    "you-should-use|https://github.com/MichaelAquilina/zsh-you-should-use"
    "zsh-autosuggestions|https://github.com/zsh-users/zsh-autosuggestions"
    "zsh-syntax-highlighting|https://github.com/zsh-users/zsh-syntax-highlighting"
)

# =============================================================================
# COMMANDS
# =============================================================================

dotfiles_update() {
    print_step "Updating dotfiles"

    # Pull latest changes
    if git -C "$DOTFILES_DIR" pull origin main; then
        print_success "Dotfiles updated"

        # Relink configurations
        dotfiles_link
    else
        print_error "Failed to update dotfiles"
        return 1
    fi
}

dotfiles_link() {
    print_step "Linking configurations"
    
    # Run setup_configurations with dotfiles directory
    setup_configurations "$DOTFILES_DIR"
    
    print_success "Configurations linked"
}

dotfiles_status() {
    print_step "Dotfiles Status"

    # Git status
    printf "\n${BOLD}Git Status:${RESET}\n"
    git -C "$DOTFILES_DIR" status --short
    
    # Check for broken symlinks
    printf "\n${BOLD}Checking symlinks:${RESET}\n"
    local broken_links=0
    while IFS=: read -r source dest; do
        # Skip comments and empty lines
        [[ "$source" =~ ^#.*$ ]] || [[ -z "$source" ]] && continue
        
        # Expand tilde in destination
        dest="${dest/#\~/$HOME}"
        
        if [[ -L "$dest" ]]; then
            if [[ ! -e "$dest" ]]; then
                print_error "Broken: $dest"
                broken_links=$((broken_links + 1))
            fi
        elif [[ ! -e "$dest" ]]; then
            print_warning "Missing: $dest"
        fi
    done < "$DOTFILES_DIR/config/mapping.cfg"
    
    if [[ $broken_links -eq 0 ]]; then
        print_success "All symlinks healthy"
    fi
    
    # Environment info
    printf "\n${BOLD}Environment:${RESET}\n"
    if [[ -d "$HOME/Work" ]] || [[ -d "$HOME/work" ]]; then
        echo "Type: work"
    else
        echo "Type: personal"
    fi
    echo "Shell: $SHELL"
    echo "Dotfiles: $DOTFILES_DIR"
}

dotfiles_setup() {
    print_step "Setting up dotfiles dependencies"

    # 1. Homebrew
    if ! command -v brew &>/dev/null; then
        print_info "Installing Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        if [[ -f "/opt/homebrew/bin/brew" ]]; then
            eval "$(/opt/homebrew/bin/brew shellenv)"
        elif [[ -f "/usr/local/bin/brew" ]]; then
            eval "$(/usr/local/bin/brew shellenv)"
        fi
        print_success "Homebrew installed"
    else
        print_success "Homebrew already installed"
    fi

    # 2. Brew packages
    print_step "Installing brew packages"
    local installed
    installed=$(brew list --formula -1 2>/dev/null)
    local to_install=()

    for pkg in "${BREW_PACKAGES[@]}"; do
        if echo "$installed" | grep -qx "$pkg"; then
            print_success "$pkg"
        else
            to_install+=("$pkg")
        fi
    done

    if [[ ${#to_install[@]} -gt 0 ]]; then
        print_info "Installing: ${to_install[*]}"
        brew install "${to_install[@]}"
        for pkg in "${to_install[@]}"; do
            if command -v "$pkg" &>/dev/null || brew list "$pkg" &>/dev/null; then
                print_success "$pkg installed"
            else
                print_error "Failed to install $pkg"
            fi
        done
    fi

    # 3. Oh My Zsh
    print_step "Checking Oh My Zsh"
    if [[ ! -d "$HOME/.oh-my-zsh" ]]; then
        print_info "Installing Oh My Zsh..."
        RUNZSH=no KEEP_ZSHRC=yes sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
        print_success "Oh My Zsh installed"
    else
        print_success "Oh My Zsh already installed"
    fi

    # 4. Custom plugins
    print_step "Checking Oh My Zsh plugins"
    local plugins_dir="$HOME/.oh-my-zsh/custom/plugins"
    mkdir -p "$plugins_dir"

    for entry in "${OMZ_CUSTOM_PLUGINS[@]}"; do
        local name="${entry%%|*}"
        local repo="${entry##*|}"

        if [[ -d "$plugins_dir/$name" ]]; then
            print_success "$name"
        else
            print_info "Cloning $name..."
            if git clone --depth=1 "$repo" "$plugins_dir/$name" 2>/dev/null; then
                print_success "$name installed"
            else
                print_error "Failed to clone $name"
            fi
        fi
    done

    # 5. Link configurations
    dotfiles_link

    # 6. Set default shell to zsh if needed
    if [[ "$SHELL" != *"zsh"* ]]; then
        print_info "Setting default shell to zsh..."
        local zsh_path
        zsh_path=$(which zsh)
        if grep -qx "$zsh_path" /etc/shells; then
            chsh -s "$zsh_path"
            print_success "Default shell set to zsh"
        else
            print_warning "zsh not in /etc/shells — add it with: sudo sh -c 'echo $zsh_path >> /etc/shells'"
        fi
    fi

    echo ""
    print_success "Setup complete! Run 'exec \$SHELL -l' to reload."
}

dotfiles_doctor() {
    print_step "Running diagnostics"

    local issues=0

    # Check shell
    if [[ "$SHELL" != *"zsh"* ]]; then
        print_warning "Default shell is not zsh"
        issues=$((issues + 1))
    else
        print_success "Shell: zsh"
    fi

    # Check dotfiles symlink
    if [[ -L "$HOME/.zshrc" ]] && [[ -e "$HOME/.zshrc" ]]; then
        print_success "zshrc linked"
    else
        print_warning "zshrc not properly linked"
        issues=$((issues + 1))
    fi

    # Check Oh My Zsh
    if [[ -d "$HOME/.oh-my-zsh" ]]; then
        print_success "Oh My Zsh"
    else
        print_warning "Oh My Zsh not installed"
        issues=$((issues + 1))
    fi

    # Check brew packages
    printf "\n${BOLD}Brew packages:${RESET}\n"
    local installed
    installed=$(brew list --formula -1 2>/dev/null)
    for pkg in "${BREW_PACKAGES[@]}"; do
        if echo "$installed" | grep -qx "$pkg"; then
            print_success "$pkg"
        else
            print_warning "Missing: $pkg"
            issues=$((issues + 1))
        fi
    done

    # Check Oh My Zsh plugins
    printf "\n${BOLD}Oh My Zsh plugins:${RESET}\n"
    for entry in "${OMZ_CUSTOM_PLUGINS[@]}"; do
        local name="${entry%%|*}"
        if [[ -d "$HOME/.oh-my-zsh/custom/plugins/$name" ]]; then
            print_success "$name"
        else
            print_warning "Missing: $name"
            issues=$((issues + 1))
        fi
    done

    echo ""
    if [[ $issues -eq 0 ]]; then
        print_success "No issues found"
    else
        print_warning "Found $issues issue(s) — run 'dotfiles setup' to fix"
    fi
}

dotfiles_edit() {
    print_step "Opening dotfiles in ${EDITOR:-vim}"
    
    # Use EDITOR if set, otherwise default to vim
    "${EDITOR:-vim}" "$DOTFILES_DIR"
}

dotfiles_reload() {
    print_step "Reloading shell configuration"
    
    if [[ -f "$HOME/.zshrc" ]]; then
        print_success "Restarting shell to reload configuration"
        exec "$SHELL" -l
    else
        print_error "No .zshrc found"
        return 1
    fi
}

dotfiles_clean() {
    print_step "Cleaning broken symlinks"
    
    local cleaned=0
    while IFS=: read -r source dest; do
        # Skip comments and empty lines
        [[ "$source" =~ ^#.*$ ]] || [[ -z "$source" ]] && continue
        
        # Expand tilde in destination
        dest="${dest/#\~/$HOME}"
        
        if [[ -L "$dest" ]] && [[ ! -e "$dest" ]]; then
            rm "$dest"
            print_success "Removed broken symlink: $dest"
            cleaned=$((cleaned + 1))
        fi
    done < "$DOTFILES_DIR/config/mapping.cfg"
    
    if [[ $cleaned -eq 0 ]]; then
        print_success "No broken symlinks found"
    else
        print_success "Cleaned $cleaned broken symlink(s)"
    fi
}

dotfiles_sync() {
    print_step "Syncing dotfiles to remote"

    # Check if there are changes to commit (modified, added, or untracked files)
    if ! git -C "$DOTFILES_DIR" diff --quiet || ! git -C "$DOTFILES_DIR" diff --cached --quiet || [[ -n $(git -C "$DOTFILES_DIR" ls-files --others --exclude-standard) ]]; then
        print_question "Commit message (or press Enter for default): "
        read -r commit_msg

        if [[ -z "$commit_msg" ]]; then
            commit_msg="Update dotfiles configuration"
        fi

        git -C "$DOTFILES_DIR" add .
        git -C "$DOTFILES_DIR" commit -m "$commit_msg"
        print_success "Changes committed"
    else
        print_success "No changes to commit"
    fi

    # Push to remote
    if git -C "$DOTFILES_DIR" push; then
        print_success "Changes pushed to remote"
    else
        print_error "Failed to push changes"
        return 1
    fi
}

dotfiles_help() {
    printf "${BOLD}dotfiles - Dotfiles management${RESET}\n"
    echo ""
    printf "${BOLD}USAGE:${RESET}\n"
    echo "    dotfiles <command>"
    echo ""
    printf "${BOLD}COMMANDS:${RESET}\n"
    echo "    setup     Install all dependencies (brew, oh-my-zsh, plugins)"
    echo "    edit      Open dotfiles in \$EDITOR"
    echo "    update    Pull latest changes and relink configurations"
    echo "    link      Link all configurations from mapping file"
    echo "    status    Show current dotfiles status"
    echo "    doctor    Check for missing dependencies and issues"
    echo "    reload    Reload shell configuration"
    echo "    clean     Remove broken symlinks"
    echo "    sync      Commit and push changes"
    echo "    help      Show this help message"
}

# =============================================================================
# MAIN
# =============================================================================

case "${1:-help}" in
    setup)
        dotfiles_setup
        ;;
    edit)
        dotfiles_edit
        ;;
    update)
        dotfiles_update
        ;;
    link)
        dotfiles_link
        ;;
    status)
        dotfiles_status
        ;;
    doctor)
        dotfiles_doctor
        ;;
    reload)
        dotfiles_reload
        ;;
    clean)
        dotfiles_clean
        ;;
    sync)
        dotfiles_sync
        ;;
    help|--help|-h)
        dotfiles_help
        ;;
    *)
        print_error "Unknown command: $1"
        dotfiles_help
        exit 1
        ;;
esac